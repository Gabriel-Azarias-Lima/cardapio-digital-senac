-- === Tabelas base ===
CREATE TABLE categorias (
  id          SERIAL PRIMARY KEY,
  nome        VARCHAR(100) NOT NULL,
  slug        VARCHAR(100) NOT NULL UNIQUE,
  created_at  TIMESTAMP DEFAULT NOW()
);

CREATE TABLE produtos (
  id             SERIAL PRIMARY KEY,
  categoria_id   INT NOT NULL,
  nome           VARCHAR(150) NOT NULL,
  descricao      VARCHAR(500),
  preco          NUMERIC(10,2) NOT NULL,
  imagem_url     VARCHAR(500),
  ativo          BOOLEAN DEFAULT TRUE,
  created_at     TIMESTAMP DEFAULT NOW(),
  CONSTRAINT fk_produtos_categoria
    FOREIGN KEY (categoria_id) REFERENCES categorias(id)
    ON UPDATE CASCADE ON DELETE RESTRICT
);

CREATE TABLE clientes (
  id          SERIAL PRIMARY KEY,
  nome        VARCHAR(150) NOT NULL,
  telefone    VARCHAR(30)  NOT NULL UNIQUE,
  created_at  TIMESTAMP DEFAULT NOW()
);

CREATE TABLE enderecos (
  id           SERIAL PRIMARY KEY,
  cliente_id   INT NOT NULL,
  rua          VARCHAR(200) NOT NULL,
  numero       VARCHAR(20)  NOT NULL,
  bairro       VARCHAR(120) NOT NULL,
  cidade       VARCHAR(120) NOT NULL,
  referencia   VARCHAR(200),
  observacoes  TEXT,
  created_at   TIMESTAMP DEFAULT NOW(),
  CONSTRAINT fk_enderecos_cliente
    FOREIGN KEY (cliente_id) REFERENCES clientes(id)
    ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE carrinhos (
  id           BIGSERIAL PRIMARY KEY,
  cliente_id   INT NULL,
  session_id   VARCHAR(100) NULL UNIQUE,
  status       VARCHAR(20) NOT NULL DEFAULT 'aberto'
                 CHECK (status IN ('aberto','expirado','convertido')),
  created_at   TIMESTAMP DEFAULT NOW(),
  updated_at   TIMESTAMP,
  expires_at   TIMESTAMP NULL,
  CONSTRAINT fk_carrinhos_cliente
    FOREIGN KEY (cliente_id) REFERENCES clientes(id)
    ON UPDATE CASCADE ON DELETE SET NULL
);

CREATE TABLE carrinho_itens (
  id              BIGSERIAL PRIMARY KEY,
  carrinho_id     BIGINT NOT NULL,
  produto_id      INT NOT NULL,
  quantidade      INT NOT NULL,
  preco_unitario  NUMERIC(10,2) NOT NULL,
  subtotal        NUMERIC(10,2) GENERATED ALWAYS AS (quantidade * preco_unitario) STORED,
  created_at      TIMESTAMP DEFAULT NOW(),
  CONSTRAINT fk_carrinho_itens_carrinho
    FOREIGN KEY (carrinho_id) REFERENCES carrinhos(id)
    ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT fk_carrinho_itens_produto
    FOREIGN KEY (produto_id) REFERENCES produtos(id)
    ON UPDATE CASCADE ON DELETE RESTRICT,
  CONSTRAINT uk_item_unico UNIQUE (carrinho_id, produto_id)
);

CREATE TABLE pedidos (
  id               BIGSERIAL PRIMARY KEY,
  cliente_id       INT NOT NULL,
  tipo_pedido      VARCHAR(20) NOT NULL
                     CHECK (tipo_pedido IN ('retirar','entrega')),
  endereco_id      INT NULL,
  metodo_pagamento VARCHAR(20) NOT NULL
                     CHECK (metodo_pagamento IN ('dinheiro','cartao','pix')),
  troco_para       NUMERIC(10,2),
  total            NUMERIC(10,2) NOT NULL,
  status           VARCHAR(20) NOT NULL DEFAULT 'criado'
                     CHECK (status IN ('criado','confirmado','em_preparo','a_caminho','entregue','cancelado')),
  created_at       TIMESTAMP DEFAULT NOW(),
  CONSTRAINT fk_pedidos_cliente
    FOREIGN KEY (cliente_id) REFERENCES clientes(id)
    ON UPDATE CASCADE ON DELETE RESTRICT,
  CONSTRAINT fk_pedidos_endereco
    FOREIGN KEY (endereco_id) REFERENCES enderecos(id)
    ON UPDATE CASCADE ON DELETE SET NULL
);

CREATE TABLE pedido_itens (
  id              BIGSERIAL PRIMARY KEY,
  pedido_id       BIGINT NOT NULL,
  produto_id      INT NOT NULL,
  quantidade      INT NOT NULL,
  preco_unitario  NUMERIC(10,2) NOT NULL,
  subtotal        NUMERIC(10,2) GENERATED ALWAYS AS (quantidade * preco_unitario) STORED,
  CONSTRAINT fk_pedido_itens_pedido
    FOREIGN KEY (pedido_id) REFERENCES pedidos(id)
    ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT fk_pedido_itens_produto
    FOREIGN KEY (produto_id) REFERENCES produtos(id)
    ON UPDATE CASCADE ON DELETE RESTRICT
);

-- === Seeds: Categorias ===
INSERT INTO categorias (nome, slug) VALUES
('Pizzas Tradicionais', 'pizzas-tradicionais'),
('Pizzas Especiais',    'pizzas-especiais'),
('Pizzas Doces',        'pizzas-doces'),
('Combos Especiais',    'combos'),
('Promoções do Dia',    'promocoes'),
('Bebidas',             'bebidas');

-- === Seeds: Produtos ===
-- Tradicionais
INSERT INTO produtos (categoria_id, nome, descricao, preco, imagem_url) VALUES
((SELECT id FROM categorias WHERE slug='pizzas-tradicionais'),'Pizza Margherita','Molho de tomate, mussarela, manjericão fresco e azeite',45.00,'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?w=400&h=300&fit=crop'),
((SELECT id FROM categorias WHERE slug='pizzas-tradicionais'),'Pizza Calabresa','Calabresa fatiada, cebola, mussarela e azeitonas',48.00,'https://images.unsplash.com/photo-1628840042765-356cda07504e?w=400&h=300&fit=crop'),
((SELECT id FROM categorias WHERE slug='pizzas-tradicionais'),'Pizza Mussarela','Deliciosa mussarela de primeira qualidade',42.00,'https://images.unsplash.com/photo-1571997478779-2adcbbe9ab2f?w=400&h=300&fit=crop'),
((SELECT id FROM categorias WHERE slug='pizzas-tradicionais'),'Pizza Portuguesa','Presunto, ovos, cebola, azeitonas e mussarela',52.00,'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&h=300&fit=crop');

-- Especiais
INSERT INTO produtos (categoria_id, nome, descricao, preco, imagem_url) VALUES
((SELECT id FROM categorias WHERE slug='pizzas-especiais'),'Pizza Quattro Formaggi','Mussarela, gorgonzola, parmesão e provolone',58.00,'https://images.unsplash.com/photo-1513104890138-7c749659a591?w=400&h=300&fit=crop'),
((SELECT id FROM categorias WHERE slug='pizzas-especiais'),'Pizza Pepperoni Premium','Pepperoni especial, mussarela e orégano',55.00,'https://images.unsplash.com/photo-1628840042765-356cda07504e?w=400&h=300&fit=crop'),
((SELECT id FROM categorias WHERE slug='pizzas-especiais'),'Pizza Toscana','Calabresa, bacon, tomate seco e catupiry',60.00,'https://images.unsplash.com/photo-1595854341625-f33ee10dbf94?w=400&h=300&fit=crop');

-- Doces
INSERT INTO produtos (categoria_id, nome, descricao, preco, imagem_url) VALUES
((SELECT id FROM categorias WHERE slug='pizzas-doces'),'Pizza de Chocolate','Chocolate ao leite derretido com granulado',38.00,'https://images.unsplash.com/photo-1606312619070-d48b4ccd8e8f?w=400&h=300&fit=crop'),
((SELECT id FROM categorias WHERE slug='pizzas-doces'),'Pizza Romeu e Julieta','Queijo minas e goiabada derretida',40.00,'https://images.unsplash.com/photo-1571091718767-18b5b1457add?w=400&h=300&fit=crop'),
((SELECT id FROM categorias WHERE slug='pizzas-doces'),'Pizza de Nutella com Morango','Nutella cremosa com morangos frescos',45.00,'https://images.unsplash.com/photo-1576458088443-04a19c1de3c1?w=400&h=300&fit=crop');
